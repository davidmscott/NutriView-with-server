<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Nutrition Chart</title>
		<style>
			.legend {
				font-size: 12px;
			}
			rect {
				stroke-width: 2;
			}
		</style>
		<script
			src="https://code.jquery.com/jquery-3.1.1.min.js"
			integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
			crossorigin="anonymous"></script>
		<script src="https://d3js.org/d3.v4.min.js"></script>
	</head>
	<body>
		<form onsubmit="event.preventDefault()">
			<input type="text" id="search">
			<button onclick="searchFood()"></button>
		</form>
		<div id="chart"></div>
		<script>

			var dataset = [
				{ label: 'Protein', count: 1, percent: 0 },
				{ label: 'Carb', count: 1, percent: 0 },
				{ label: 'Fat', count: 1, percent: 0 }
			];

			function searchFood() {
				var search = $('#search').val();
				console.log(search);
				$.get('/nutrients', search, function(res) {
					console.log(res);
					var totalDaily = JSON.parse(res.body).totalDaily;
						dataset[0].percent = totalDaily.FAT ? totalDaily.FAT.quantity : 0;
						dataset[1].percent = totalDaily.CHOCDF ? totalDaily.CHOCDF.quantity : 0;
						dataset[2].percent = totalDaily.PROCNT ? totalDaily.PROCNT.quantity : 0;
				var width = 600;
				var height = 600;
				var radius = Math.min(width, height) / 2;
				var insideRadius = radius / 3;
				var legendRectSize = 18;
				var legendSpacing = 4;

				// var color = d3.scaleOrdinal(d3.schemeCategory20);

				var color = d3.scaleOrdinal()
					.range(['#A60F2B', '#648C85', '#B3F2C9', '#528C18', '#C3F25C']);

				var svg = d3.select('#chart')
					.append('svg')
					.attr('width', width)
					.attr('height', height)
					.append('g')
					.attr('transform', 'translate(' + (width / 2) +
						',' + (height / 2) + ')');

				var arc = d3.arc()
					.innerRadius(insideRadius)
					.outerRadius(radius);

				var pie = d3.pie()
					.value(function(d) { return d.count; })
					.sort(null);

				var path = svg.selectAll('path')
					.data(pie(dataset))
					.enter()
					.append('path')
					.attr('d', function(d, i) { return arc.outerRadius(insideRadius + d.data.percent)(d, i); })
					.attr('fill', function(d) {
						return color(d.data.label);
					});

				var legend = svg.selectAll('.legend')
					.data(color.domain())
					.enter()
					.append('g')
					.attr('class', 'legend')
					.attr('transform', function(d, i) {
						var height = legendRectSize + legendSpacing;
						var offset =  height * color.domain().length / 2;
						var horz = -2 * legendRectSize;
						var vert = i * height - offset;
						return 'translate(' + horz + ',' + vert + ')';
					});

				legend.append('rect')
					.attr('width', legendRectSize)
					.attr('height', legendRectSize)
					.style('fill', color)
					.style('stroke', color);

				legend.append('text')
					.attr('x', legendRectSize + legendSpacing)
					.attr('y', legendRectSize - legendSpacing)
					.text(function(d) { return d; });

				});
			}

		</script>
	</body>
</html>